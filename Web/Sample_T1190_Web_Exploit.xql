/*
==============================================================================
CORTEX XDR XQL DETECTION - WEB EXPLOIT
==============================================================================
Rule: Potential Web Shell Activity
ID: XQL-WEB-001
Author: Mathan
Date: 2025-12-02
MITRE: T1505.003 (Web Shell)
Severity: CRITICAL
==============================================================================

WHAT IT DETECTS:
Identifies web server processes (w3wp, httpd) spawning command shells (cmd, bash),
often indicating a web shell.

THE QUERY:
*/

config case_sensitive = false timeframe = 1h
| dataset = xdr_data
| filter event_type = ENUM.PROCESS_LAUNCH
    and causality_actor_process_image_name ~= ".*(w3wp\.exe|httpd\.exe|nginx\.exe)"
    and actor_process_image_name ~= ".*(cmd\.exe|powershell\.exe|bash|sh)"
| fields _time, agent_hostname, causality_actor_process_image_name, actor_process_image_name
| alter severity = "CRITICAL"

/*
==============================================================================
TUNING
==============================================================================
False Positives:
- Valid admin tools run via web interface (rare)

Exclusions:
| filter agent_hostname != "dev-server"

==============================================================================
TESTING
==============================================================================
Test Command: 
On IIS server, use a PHP/ASP script to execute 'cmd.exe /c whoami'.

Expected Result:
Alert triggers showing w3wp spawning cmd.exe.
==============================================================================
*/
